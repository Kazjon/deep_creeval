import pymongo

#Perform the escape character nonsense we need to put in the DB -- mongo keys can't start with $, we replaced with __
def escape_mongo(metadata):
	for k in metadata.keys():
		if type(metadata[k]) is dict:
			escape_mongo(metadata[k])
		if type(metadata[k]) is list:
			for l in metadata[k]:
				if type(l) is dict:
					escape_mongo(l)
		if k.startswith("$"):
			print 'found',k
			metadata["__"+k.lstrip("$")] = metadata[k]
			del metadata[k]


#Reverse the escape character nonsense we had to put in the DB -- mongo keys can't start with $, we replaced with __
def unescape_mongo(metadata):
	for k in metadata.keys():
		if type(metadata[k]) is dict:
			unescape_mongo(metadata[k])
		if type(metadata[k]) is list:
			for l in metadata[k]:
				if type(l) is dict:
					unescape_mongo(l)
		if k.startswith("__"):
			metadata["$"+k.lstrip("_")] = metadata[k]
			del metadata[k]


domain_name = "ebird"
client = pymongo.MongoClient()
db = client.creeval
metadata = db.datasets.find_one({"name": domain_name})
unescape_mongo(metadata)

metadata["steps"] = [{'objective': 31.880125045776367, 'model_files': ['data/ebird/expectations2/step_0/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_0/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_0/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_0/ebird_sdae_l4.pkl'], 'stop': 2011.0, 'training_objectives': [[91.36312866210938, 34.15362548828125, 27.306686401367188, 23.998714447021484, 21.547683715820312, 19.9332275390625, 18.83341407775879, 18.201622009277344, 17.72395896911621, 17.319286346435547, 16.898014068603516], [28.318681716918945, 15.69365406036377, 11.8295259475708, 9.690974235534668, 8.309216499328613, 7.230004787445068, 6.322371482849121, 5.576085090637207, 4.974852561950684, 4.488644123077393, 4.108262538909912], [19.17953109741211, 11.929001808166504, 7.9745869636535645, 6.092733860015869, 4.891475200653076, 4.059060096740723, 3.472825050354004, 3.0695629119873047, 2.780968189239502, 2.563009738922119, 2.3903579711914062], [14.051114082336426, 13.95467472076416, 12.821769714355469, 10.742668151855469, 9.56013298034668, 9.039822578430176, 8.812548637390137, 8.690143585205078, 8.606203079223633, 8.539641380310059, 8.483489990234375]], 'start': 2010.0}, {'objective': 30.744464874267578, 'model_files': ['data/ebird/expectations2/step_1/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_1/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_1/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_1/ebird_sdae_l4.pkl'], 'stop': 2011.083333, 'training_objectives': [[17.060287475585938, 16.917692184448242, 16.50440788269043, 16.279367446899414, 16.309551239013672, 16.113014221191406, 16.29537582397461, 16.257366180419922, 15.920355796813965, 16.18933868408203, 16.11880874633789], [4.95512056350708, 4.764267921447754, 4.612213134765625, 4.484030246734619, 4.380370140075684, 4.2963433265686035, 4.225090503692627, 4.1568708419799805, 4.0930585861206055, 4.051995754241943, 3.9990715980529785], [2.9566490650177, 2.8767130374908447, 2.7941486835479736, 2.7341861724853516, 2.669804573059082, 2.628467321395874, 2.5865495204925537, 2.546905279159546, 2.512157440185547, 2.484164237976074, 2.4624104499816895], [8.883435249328613, 8.787894248962402, 8.70151138305664, 8.621623039245605, 8.546627044677734, 8.47555923461914, 8.407878875732422, 8.34316349029541, 8.281085014343262, 8.221467018127441, 8.164175987243652]], 'start': 2011.0}, {'objective': 29.183116912841797, 'model_files': ['data/ebird/expectations2/step_2/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_2/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_2/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_2/ebird_sdae_l4.pkl'], 'stop': 2011.166666, 'training_objectives': [[15.816088676452637, 16.120601654052734, 15.94188117980957, 16.254535675048828, 15.709364891052246, 15.715807914733887, 15.947341918945312, 15.446747779846191, 15.660258293151855, 15.504582405090332, 15.338726043701172], [4.1055908203125, 4.049683570861816, 4.004158973693848, 3.9690144062042236, 3.92730975151062, 3.8904104232788086, 3.863921642303467, 3.830359935760498, 3.7979485988616943, 3.7630436420440674, 3.736053228378296], [2.636507034301758, 2.6109769344329834, 2.5826947689056396, 2.5616202354431152, 2.5345191955566406, 2.5186960697174072, 2.487827777862549, 2.4652903079986572, 2.448669672012329, 2.429743528366089, 2.4152278900146484], [8.028663635253906, 7.988245010375977, 7.94982385635376, 7.9130167961120605, 7.877817153930664, 7.8439435958862305, 7.811438083648682, 7.780176162719727, 7.749946117401123, 7.720953464508057, 7.69310998916626]], 'start': 2011.083333}, {'objective': 30.273677825927734, 'model_files': ['data/ebird/expectations2/step_3/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_3/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_3/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_3/ebird_sdae_l4.pkl'], 'stop': 2011.2499990000001, 'training_objectives': [[17.19291114807129, 16.923446655273438, 16.748987197875977, 16.67739486694336, 16.628808975219727, 16.533735275268555, 16.469606399536133, 16.32093620300293, 16.345407485961914, 16.540172576904297, 16.511734008789062], [4.179419994354248, 4.074934005737305, 3.996640205383301, 3.930727958679199, 3.868706464767456, 3.8222317695617676, 3.7764503955841064, 3.731501817703247, 3.6959705352783203, 3.6628448963165283, 3.632995843887329], [2.7945706844329834, 2.7224252223968506, 2.666607141494751, 2.611086130142212, 2.5732312202453613, 2.530357599258423, 2.497927665710449, 2.4642138481140137, 2.431394577026367, 2.4037599563598633, 2.381375312805176], [7.97637939453125, 7.936755180358887, 7.905245304107666, 7.8785400390625, 7.854801177978516, 7.833347320556641, 7.813645839691162, 7.795397758483887, 7.778441905975342, 7.762511253356934, 7.7475738525390625]], 'start': 2011.166666}, {'objective': 30.784500122070312, 'model_files': ['data/ebird/expectations2/step_4/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_4/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_4/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_4/ebird_sdae_l4.pkl'], 'stop': 2011.3333320000002, 'training_objectives': [[22.5291805267334, 20.70130729675293, 19.712303161621094, 18.767824172973633, 18.228803634643555, 18.090438842773438, 17.852903366088867, 17.5293025970459, 17.502458572387695, 17.324012756347656, 17.042638778686523], [5.123318672180176, 4.707463264465332, 4.415189266204834, 4.219592571258545, 4.0655670166015625, 3.945697546005249, 3.848444700241089, 3.773205280303955, 3.7000653743743896, 3.64766788482666, 3.6026415824890137], [3.089015483856201, 2.9380545616149902, 2.8219852447509766, 2.729283094406128, 2.6539785861968994, 2.5912342071533203, 2.5263190269470215, 2.476957082748413, 2.4262478351593018, 2.3784708976745605, 2.3372437953948975], [8.113204956054688, 8.050372123718262, 8.004735946655273, 7.967560291290283, 7.935624599456787, 7.907434463500977, 7.882170677185059, 7.859323978424072, 7.838499069213867, 7.819455623626709, 7.801976203918457]], 'start': 2011.2499990000001}, {'objective': 30.110088348388672, 'model_files': ['data/ebird/expectations2/step_5/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_5/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_5/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_5/ebird_sdae_l4.pkl'], 'stop': 2011.4166650000002, 'training_objectives': [[18.04123306274414, 17.474328994750977, 17.385501861572266, 17.265487670898438, 17.40079689025879, 17.164493560791016, 17.185985565185547, 16.93536376953125, 17.175630569458008, 16.875825881958008, 16.776277542114258], [4.037384033203125, 3.9127349853515625, 3.8108439445495605, 3.7347497940063477, 3.6729769706726074, 3.6196961402893066, 3.5620992183685303, 3.525085926055908, 3.488298177719116, 3.4471702575683594, 3.4123997688293457], [2.6668307781219482, 2.589416265487671, 2.520984172821045, 2.459843158721924, 2.405902147293091, 2.3592190742492676, 2.3113110065460205, 2.2727370262145996, 2.2291667461395264, 2.1907689571380615, 2.1592249870300293], [7.98847770690918, 7.951207637786865, 7.920939922332764, 7.894482135772705, 7.870615482330322, 7.848775386810303, 7.828779697418213, 7.8102641105651855, 7.79307222366333, 7.777083873748779, 7.762186527252197]], 'start': 2011.3333320000002}, {'objective': 28.36484718322754, 'model_files': ['data/ebird/expectations2/step_6/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_6/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_6/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_6/ebird_sdae_l4.pkl'], 'stop': 2011.4999980000002, 'training_objectives': [[19.525070190429688, 18.2791805267334, 17.57445526123047, 17.374996185302734, 16.706005096435547, 16.548410415649414, 16.717073440551758, 16.425884246826172, 15.915772438049316, 16.100955963134766, 15.7777681350708], [5.150423049926758, 4.705402374267578, 4.366523742675781, 4.09946346282959, 3.898846387863159, 3.741028070449829, 3.614851713180542, 3.511564254760742, 3.4329471588134766, 3.3674659729003906, 3.3122189044952393], [2.3513453006744385, 2.2786178588867188, 2.220017194747925, 2.1702463626861572, 2.12641978263855, 2.0918853282928467, 2.0626778602600098, 2.0332417488098145, 2.0049610137939453, 1.9810255765914917, 1.95692777633667], [7.507928371429443, 7.480804920196533, 7.457247734069824, 7.435847282409668, 7.416008949279785, 7.397411823272705, 7.379852294921875, 7.363214015960693, 7.3473896980285645, 7.33231258392334, 7.31793212890625]], 'start': 2011.4166650000002}, {'objective': 27.990659713745117, 'model_files': ['data/ebird/expectations2/step_7/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_7/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_7/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_7/ebird_sdae_l4.pkl'], 'stop': 2011.5833310000003, 'training_objectives': [[16.346555709838867, 15.913025856018066, 15.878310203552246, 15.859214782714844, 15.915186882019043, 15.673445701599121, 15.638640403747559, 15.72247314453125, 15.405830383300781, 15.535673141479492, 15.821653366088867], [3.4224774837493896, 3.3654491901397705, 3.320648670196533, 3.2814693450927734, 3.2453997135162354, 3.2171576023101807, 3.1975457668304443, 3.1708109378814697, 3.1540746688842773, 3.129594326019287, 3.117079496383667], [2.050067901611328, 2.022967576980591, 2.0006794929504395, 1.979840874671936, 1.9584095478057861, 1.939910888671875, 1.9217084646224976, 1.9080018997192383, 1.8918956518173218, 1.8838393688201904, 1.8616050481796265], [7.309829235076904, 7.294616222381592, 7.280676364898682, 7.267603874206543, 7.2552008628845215, 7.2433576583862305, 7.231979846954346, 7.221015930175781, 7.210442066192627, 7.200223445892334, 7.190322399139404]], 'start': 2011.4999980000002}, {'objective': 27.181013107299805, 'model_files': ['data/ebird/expectations2/step_8/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_8/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_8/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_8/ebird_sdae_l4.pkl'], 'stop': 2011.6666640000003, 'training_objectives': [[15.115446090698242, 14.836546897888184, 14.898520469665527, 15.59842586517334, 14.899069786071777, 15.101197242736816, 15.130041122436523, 15.018929481506348, 14.906865119934082, 14.730387687683105, 14.992633819580078], [3.3850739002227783, 3.371324062347412, 3.3544585704803467, 3.3389179706573486, 3.3293344974517822, 3.309553384780884, 3.3045601844787598, 3.290846347808838, 3.2817468643188477, 3.2734596729278564, 3.257899284362793], [1.8841410875320435, 1.8733954429626465, 1.8644216060638428, 1.8571590185165405, 1.8499996662139893, 1.8379420042037964, 1.8309959173202515, 1.8160240650177002, 1.8142026662826538, 1.8037912845611572, 1.797361969947815], [7.172304153442383, 7.167491912841797, 7.163028240203857, 7.158679962158203, 7.154693126678467, 7.150872230529785, 7.14713716506958, 7.143548488616943, 7.140034198760986, 7.136537551879883, 7.133117198944092]], 'start': 2011.5833310000003}, {'objective': 27.528955459594727, 'model_files': ['data/ebird/expectations2/step_9/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_9/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_9/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_9/ebird_sdae_l4.pkl'], 'stop': 2011.7499970000003, 'training_objectives': [[16.326404571533203, 15.559137344360352, 15.450431823730469, 15.570076942443848, 15.335282325744629, 15.466418266296387, 15.25924301147461, 15.377335548400879, 15.36985969543457, 15.085144996643066, 15.24716854095459], [3.3734116554260254, 3.3443872928619385, 3.3280482292175293, 3.297661304473877, 3.282017230987549, 3.2645630836486816, 3.240424156188965, 3.2294466495513916, 3.221095085144043, 3.2064030170440674, 3.199232816696167], [1.9727504253387451, 1.9574403762817383, 1.9396591186523438, 1.9303295612335205, 1.9189798831939697, 1.9114186763763428, 1.8952879905700684, 1.8825891017913818, 1.8794682025909424, 1.8693852424621582, 1.8605527877807617], [7.258819103240967, 7.252865314483643, 7.247924327850342, 7.243535041809082, 7.239685535430908, 7.236201763153076, 7.232980251312256, 7.2299699783325195, 7.227168083190918, 7.224515914916992, 7.222002029418945]], 'start': 2011.6666640000003}, {'objective': 28.659198760986328, 'model_files': ['data/ebird/expectations2/step_10/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_10/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_10/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_10/ebird_sdae_l4.pkl'], 'stop': 2011.8333300000004, 'training_objectives': [[16.766910552978516, 16.6960391998291, 16.430374145507812, 16.567949295043945, 16.37310028076172, 16.284502029418945, 16.001768112182617, 16.032548904418945, 16.17078971862793, 16.312902450561523, 16.002670288085938], [3.6843292713165283, 3.6103169918060303, 3.5570590496063232, 3.507331609725952, 3.4703311920166016, 3.4289581775665283, 3.3981356620788574, 3.3662242889404297, 3.3449904918670654, 3.3186445236206055, 3.29241943359375], [2.14115047454834, 2.116450309753418, 2.093859910964966, 2.063554286956787, 2.0423436164855957, 2.0231544971466064, 2.008566379547119, 1.9919108152389526, 1.9757280349731445, 1.9619003534317017, 1.943526268005371], [7.4937944412231445, 7.482937335968018, 7.473578929901123, 7.465262413024902, 7.457665920257568, 7.4506449699401855, 7.444045543670654, 7.437783241271973, 7.431818008422852, 7.426087379455566, 7.420581817626953]], 'start': 2011.7499970000003}, {'objective': 27.466930389404297, 'model_files': ['data/ebird/expectations2/step_11/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_11/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_11/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_11/ebird_sdae_l4.pkl'], 'stop': 2011.9166630000004, 'training_objectives': [[15.722738265991211, 15.09632396697998, 15.208913803100586, 15.00161075592041, 14.726301193237305, 14.952859878540039, 14.631121635437012, 14.642363548278809, 14.65926456451416, 14.833598136901855, 14.849355697631836], [3.7164554595947266, 3.6217963695526123, 3.542086124420166, 3.4742016792297363, 3.415362596511841, 3.3585686683654785, 3.3183200359344482, 3.268343448638916, 3.2313828468322754, 3.2050726413726807, 3.1748459339141846], [2.3949134349823, 2.352104663848877, 2.3140954971313477, 2.270875930786133, 2.238311767578125, 2.2122275829315186, 2.1792569160461426, 2.1517372131347656, 2.1248679161071777, 2.103438138961792, 2.07855224609375], [7.5270490646362305, 7.505987644195557, 7.487145900726318, 7.469707489013672, 7.453208923339844, 7.437361240386963, 7.422038555145264, 7.407105922698975, 7.392518043518066, 7.37820291519165, 7.364176273345947]], 'start': 2011.8333300000004}, {'objective': 27.148103713989258, 'model_files': ['data/ebird/expectations2/step_12/ebird_sdae_l1.pkl', 'data/ebird/expectations2/step_12/ebird_sdae_l2.pkl', 'data/ebird/expectations2/step_12/ebird_sdae_l3.pkl', 'data/ebird/expectations2/step_12/ebird_sdae_l4.pkl'], 'stop': 2011.9999960000005, 'training_objectives': [[15.259693145751953, 15.126246452331543, 14.957473754882812, 14.901018142700195, 14.67492961883545, 14.780694961547852, 15.257180213928223, 14.685697555541992, 14.875593185424805, 14.772788047790527, 14.324814796447754], [3.4561405181884766, 3.3934149742126465, 3.337116241455078, 3.274458646774292, 3.2425663471221924, 3.2028286457061768, 3.1697041988372803, 3.143887996673584, 3.11789870262146, 3.1012344360351562, 3.0817596912384033], [2.473133087158203, 2.41070556640625, 2.351001024246216, 2.304626941680908, 2.259614944458008, 2.220297336578369, 2.176456928253174, 2.147984504699707, 2.113466501235962, 2.0896496772766113, 2.0648112297058105], [8.003673553466797, 7.966411590576172, 7.931297779083252, 7.897369861602783, 7.864391803741455, 7.832039833068848, 7.800028324127197, 7.768553256988525, 7.737480163574219, 7.706888198852539, 7.676718235015869]], 'start': 2011.9166630000004}]

escape_mongo(metadata)

db.datasets.save(metadata)